package com.webbanmatkinh.controller.web;

import java.io.File;
import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import com.webbanmatkinh.constant.SystemConstant;
import com.webbanmatkinh.converter.UserConverter;
import com.webbanmatkinh.dto.ProductDTO;
import com.webbanmatkinh.dto.UserDTO;
import com.webbanmatkinh.entity.UserEntity;
import com.webbanmatkinh.repository.UserRepository;
import com.webbanmatkinh.service.ICartService;
import com.webbanmatkinh.service.IUserService;
import com.webbanmatkinh.util.SecurityUtils;

@Controller
public class UserController {

	@Autowired
	private ICartService cartService;
	
	@Autowired
	private IUserService userService;

	@Autowired
	private UserRepository userRepository;

	@Autowired
	private UserConverter userConverter;

	// ok
	@RequestMapping(value = "/dang-ki", method = RequestMethod.GET)
	public ModelAndView register() {
		ModelAndView mav = new ModelAndView("register");
		mav.addObject("user", new UserDTO());
		return mav;
	}

	// ok
	@RequestMapping(value = "/dang-ki", method = RequestMethod.POST)
	public ModelAndView createAccount(@ModelAttribute("user") UserDTO user) {
		ModelAndView mav = new ModelAndView("register");
		UserDTO userDTO = userService.insert(user);	
		if (userDTO != null) {
			mav.addObject("statusUser", "ĐĂNG KÍ THÀNH CÔNG");
			cartService.insert(userDTO.getId());
			return new ModelAndView("redirect:/dang-nhap");
		}
		return mav;
	}
	
	@RequestMapping(value = "/tai-khoan", method = RequestMethod.GET)
	public ModelAndView myaccount() {
		ModelAndView mav = new ModelAndView("web/myaccount");
		Long userId = userService.findOneByUserNameAndStatus(SecurityUtils.getPrincipal().getUsername(), SystemConstant.ACTIVE_STATUS).getId();
		UserEntity entity = userRepository.findOne(userId);
		UserDTO user = userConverter.toDto(entity);
		System.out.println(entity.getId());
		System.out.println(entity.getAddress());
		System.out.println(entity.getStatus());
		System.out.println(entity.getPassword());
		System.out.println(entity.getRole().getId());
		mav.addObject("user", user);
		return mav;
	}
	
	@RequestMapping(value = "/tai-khoan", method = RequestMethod.POST)
	public String update(@ModelAttribute("user") UserDTO user, ModelMap model) {
		Long userId = userService.findOneByUserNameAndStatus(SecurityUtils.getPrincipal().getUsername(), SystemConstant.ACTIVE_STATUS).getId();
		user.setId(userId);
		user.setStatus(SystemConstant.ACTIVE_STATUS); 
		user.setRoleid(SystemConstant.ROLE_USER);
		user.setPassword(userService.findOne(userId).getPassword());	
		model.addAttribute("model", user);
		userService.update(user);
		return "redirect:/tai-khoan";
	}
	
}
